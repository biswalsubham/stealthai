<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0a0f">
<title>StealthAI</title>
<link rel="manifest" href="manifest.json">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #1a1a24;
    --border: #ffffff10;
    --border-active: #ffffff22;
    --accent: #7c6cfc;
    --accent2: #4ecdc4;
    --accent-glow: #7c6cfc30;
    --text: #e8e8f0;
    --text-dim: #8888aa;
    --text-faint: #44445a;
    --ai-bubble: #13131e;
    --user-bubble: #1a1a2e;
    --success: #4ecca3;
    --danger: #ff6b6b;
    --heard: #ffaa44;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

  html, body {
    width:100%; height:100%;
    background:var(--bg);
    color:var(--text);
    font-family: -apple-system, 'SF Pro Display', 'Segoe UI', sans-serif;
    overflow:hidden;
    -webkit-user-select:none;
    user-select:none;
  }

  .app {
    width:100%; height:100dvh;
    display:flex; flex-direction:column;
    padding-top:var(--safe-top);
    padding-bottom:var(--safe-bottom);
    background:var(--bg);
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .header {
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 18px 12px;
    background:linear-gradient(180deg, #ffffff08 0%, transparent 100%);
    border-bottom:1px solid var(--border);
    flex-shrink:0;
  }
  .header-left { display:flex; align-items:center; gap:10px; }
  .logo-dot { width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 10px var(--accent); animation:pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(0.8)} }
  .app-name { font-size:17px; font-weight:700; letter-spacing:-0.3px; }
  .app-name span { color:var(--accent); }
  .badge { font-size:10px; padding:3px 8px; border-radius:20px; font-weight:600; letter-spacing:0.03em; }
  .badge-gemini { background:#7c6cfc20; color:#a99fff; border:1px solid #7c6cfc30; }
  .settings-btn { width:36px; height:36px; border-radius:50%; background:var(--surface2); border:1px solid var(--border-active); display:flex; align-items:center; justify-content:center; font-size:16px; cursor:pointer; transition:all 0.2s; }
  .settings-btn:active { transform:scale(0.9); background:var(--border-active); }

  /* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
  #setup-screen { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:28px 24px; gap:20px; overflow-y:auto; }
  #chat-screen { flex:1; display:none; flex-direction:column; overflow:hidden; }
  #chat-screen.active { display:flex; }

  /* ‚îÄ‚îÄ SETUP ‚îÄ‚îÄ */
  .setup-hero { text-align:center; }
  .setup-emoji { font-size:64px; display:block; margin-bottom:16px; filter:drop-shadow(0 0 24px #7c6cfc80); }
  .setup-title { font-size:28px; font-weight:800; letter-spacing:-0.5px; margin-bottom:8px; background:linear-gradient(135deg, #fff 0%, var(--accent) 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
  .setup-sub { font-size:14px; color:var(--text-dim); line-height:1.6; }
  .setup-sub strong { color:var(--success); -webkit-text-fill-color:var(--success); }

  .info-card { width:100%; background:var(--surface2); border:1px solid var(--border-active); border-radius:16px; padding:16px 18px; }
  .info-card-title { font-size:11px; color:var(--accent); font-weight:700; text-transform:uppercase; letter-spacing:0.1em; margin-bottom:8px; }
  .info-card-body { font-size:13px; color:var(--text-dim); line-height:1.65; }
  .info-card-body code { font-family:'SF Mono', monospace; color:var(--accent2); background:#ffffff08; padding:2px 6px; border-radius:5px; font-size:12px; }

  .input-group { width:100%; }
  .input-label { font-size:12px; color:var(--text-dim); font-weight:600; margin-bottom:8px; display:block; }
  .text-input { width:100%; padding:14px 16px; background:var(--surface2); border:1.5px solid var(--border-active); border-radius:14px; color:var(--text); font-size:14px; font-family:inherit; outline:none; transition:border-color 0.2s, box-shadow 0.2s; -webkit-user-select:text; user-select:text; }
  .text-input:focus { border-color:var(--accent); box-shadow:0 0 0 4px var(--accent-glow); }
  .text-input::placeholder { color:var(--text-faint); }
  .text-input.error { border-color:var(--danger); box-shadow:0 0 0 4px #ff6b6b15; }

  .btn-primary { width:100%; padding:16px; background:linear-gradient(135deg, var(--accent) 0%, #5a4fd0 100%); border:none; border-radius:14px; color:white; font-size:16px; font-weight:700; cursor:pointer; transition:all 0.2s; box-shadow:0 6px 24px #7c6cfc40; font-family:inherit; letter-spacing:-0.2px; }
  .btn-primary:active { transform:scale(0.97); box-shadow:0 2px 8px #7c6cfc40; }

  .hint-text { font-size:12px; color:var(--text-faint); text-align:center; line-height:1.7; }

  /* ‚îÄ‚îÄ AUDIO BAR ‚îÄ‚îÄ */
  .audio-bar {
    padding:12px 16px;
    border-bottom:1px solid var(--border);
    display:flex; align-items:center; gap:12px;
    flex-shrink:0;
    background:#ffffff03;
  }
  .mic-btn {
    display:flex; align-items:center; gap:8px;
    padding:10px 18px; border-radius:50px;
    border:1.5px solid var(--border-active);
    background:var(--surface2);
    color:var(--text-dim);
    font-size:13px; font-weight:600;
    cursor:pointer; transition:all 0.2s;
    white-space:nowrap; flex-shrink:0;
    font-family:inherit;
  }
  .mic-btn:active { transform:scale(0.96); }
  .mic-btn.recording {
    background:#ff444418;
    border-color:#ff444460;
    color:#ff6666;
    animation:recGlow 1.2s ease-in-out infinite;
  }
  @keyframes recGlow { 0%,100%{box-shadow:0 0 0 0 #ff444420} 50%{box-shadow:0 0 0 8px #ff444400} }
  .rec-dot { width:9px; height:9px; border-radius:50%; background:currentColor; flex-shrink:0; }
  .rec-dot.pulse { animation:dotBeat 0.8s ease-in-out infinite; }
  @keyframes dotBeat { 0%,100%{transform:scale(1)} 50%{transform:scale(1.5)} }

  .audio-info { flex:1; min-width:0; }
  .audio-status { font-size:12px; color:var(--text-faint); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .audio-status.active { color:#ff6666; }
  .audio-status.processing { color:var(--accent2); }
  .audio-status.success { color:var(--success); }

  /* ‚îÄ‚îÄ CONTEXT BAR ‚îÄ‚îÄ */
  .context-bar { padding:8px 14px; border-bottom:1px solid var(--border); display:flex; gap:8px; align-items:center; flex-shrink:0; }
  .context-label { font-size:11px; color:var(--text-faint); font-weight:700; text-transform:uppercase; letter-spacing:0.08em; white-space:nowrap; }
  .context-input { flex:1; padding:7px 12px; background:var(--surface2); border:1px solid var(--border); border-radius:10px; color:var(--text); font-size:12px; outline:none; -webkit-user-select:text; user-select:text; font-family:inherit; }
  .context-input:focus { border-color:var(--accent); }
  .context-input::placeholder { color:var(--text-faint); }

  /* ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ */
  .messages { flex:1; overflow-y:auto; padding:14px; display:flex; flex-direction:column; gap:12px; -webkit-overflow-scrolling:touch; }
  .messages::-webkit-scrollbar { display:none; }

  .message { display:flex; flex-direction:column; gap:4px; animation:msgIn 0.25s ease; }
  @keyframes msgIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

  .msg-label { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.1em; padding:0 4px; }
  .message.ai .msg-label { color:var(--accent); }
  .message.user .msg-label { color:var(--accent2); text-align:right; }
  .message.heard .msg-label { color:var(--heard); }

  .msg-bubble { padding:12px 15px; border-radius:16px; font-size:14px; line-height:1.65; color:var(--text); word-wrap:break-word; white-space:pre-wrap; -webkit-user-select:text; user-select:text; }
  .message.ai .msg-bubble { background:var(--ai-bubble); border:1px solid var(--border); border-bottom-left-radius:5px; border-left:3px solid var(--accent); }
  .message.user .msg-bubble { background:var(--user-bubble); border:1px solid var(--border-active); border-bottom-right-radius:5px; align-self:flex-end; max-width:88%; border-right:3px solid var(--accent2); }
  .message.heard .msg-bubble { background:#ffaa4410; border:1px solid #ffaa4430; border-bottom-left-radius:5px; border-left:3px solid var(--heard); color:var(--text-dim); font-style:italic; font-size:13px; }

  .msg-bubble code { font-family:'SF Mono', 'Courier New', monospace; font-size:12px; background:#ffffff0a; padding:2px 6px; border-radius:5px; color:var(--accent2); }
  .msg-bubble pre { background:#0d0d14; border:1px solid var(--border); border-radius:10px; padding:12px 14px; margin:8px 0; overflow-x:auto; font-family:'SF Mono', monospace; font-size:12px; line-height:1.5; color:#c8c8e8; white-space:pre; -webkit-overflow-scrolling:touch; }

  .typing-wrap { display:flex; align-items:center; gap:10px; padding:12px 14px; }
  .typing-dots { display:flex; gap:5px; }
  .typing-dots span { width:6px; height:6px; background:var(--accent); border-radius:50%; animation:td 1.2s infinite; opacity:0.4; }
  .typing-dots span:nth-child(2){animation-delay:0.2s} .typing-dots span:nth-child(3){animation-delay:0.4s}
  @keyframes td { 0%,100%{transform:translateY(0);opacity:0.4} 50%{transform:translateY(-5px);opacity:1} }
  .typing-text { font-size:12px; color:var(--text-faint); }

  /* ‚îÄ‚îÄ QUICK PROMPTS ‚îÄ‚îÄ */
  .quick-scroll { padding:8px 14px; border-top:1px solid var(--border); overflow-x:auto; display:flex; gap:8px; flex-shrink:0; -webkit-overflow-scrolling:touch; scrollbar-width:none; }
  .quick-scroll::-webkit-scrollbar { display:none; }
  .quick-chip { padding:7px 14px; background:var(--surface2); border:1px solid var(--border); border-radius:20px; color:var(--text-dim); font-size:12px; font-weight:500; white-space:nowrap; cursor:pointer; transition:all 0.15s; font-family:inherit; flex-shrink:0; }
  .quick-chip:active { background:var(--accent-glow); border-color:var(--accent); color:var(--accent); transform:scale(0.96); }

  /* ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ */
  .input-area { padding:10px 14px 12px; border-top:1px solid var(--border); display:flex; gap:10px; align-items:flex-end; flex-shrink:0; }
  .chat-textarea { flex:1; min-height:42px; max-height:120px; padding:11px 14px; background:var(--surface2); border:1.5px solid var(--border-active); border-radius:22px; color:var(--text); font-size:15px; font-family:inherit; outline:none; resize:none; line-height:1.45; overflow-y:auto; transition:border-color 0.2s; -webkit-user-select:text; user-select:text; }
  .chat-textarea:focus { border-color:var(--accent); }
  .chat-textarea::placeholder { color:var(--text-faint); }
  .send-btn { width:42px; height:42px; background:var(--accent); border:none; border-radius:50%; color:white; font-size:18px; cursor:pointer; transition:all 0.2s; flex-shrink:0; display:flex; align-items:center; justify-content:center; box-shadow:0 3px 12px #7c6cfc40; }
  .send-btn:active { transform:scale(0.9); }
  .send-btn:disabled { background:var(--surface2); color:var(--text-faint); box-shadow:none; }

  /* ‚îÄ‚îÄ STATUS BAR ‚îÄ‚îÄ */
  .status-bar { padding:6px 16px 8px; display:flex; justify-content:space-between; align-items:center; flex-shrink:0; }
  .status-left { display:flex; gap:7px; align-items:center; }
  .status-dot { width:6px; height:6px; border-radius:50%; background:var(--success); box-shadow:0 0 6px var(--success); }
  .status-text, .msg-count { font-size:11px; color:var(--text-faint); }

  .welcome { text-align:center; padding:40px 20px; color:var(--text-faint); }
  .welcome-emoji { font-size:48px; margin-bottom:14px; display:block; filter:drop-shadow(0 0 16px #7c6cfc80); }
  .welcome h3 { font-size:18px; font-weight:700; color:var(--text-dim); margin-bottom:10px; }
  .welcome p { font-size:14px; line-height:1.7; }
  .welcome strong { color:var(--text-dim); -webkit-text-fill-color:var(--text-dim); }

  .error-bubble { background:#ff6b6b10; border:1px solid #ff6b6b30; border-radius:12px; padding:10px 14px; color:var(--danger); font-size:13px; margin:4px 0; }

  /* Install banner for PWA */
  .install-banner { display:none; align-items:center; gap:12px; padding:12px 16px; background:linear-gradient(135deg, #7c6cfc20, #4ecdc420); border-bottom:1px solid var(--border-active); flex-shrink:0; }
  .install-banner.show { display:flex; }
  .install-text { flex:1; font-size:13px; color:var(--text-dim); }
  .install-text strong { color:var(--text); }
  .install-btn { padding:8px 16px; background:var(--accent); border:none; border-radius:10px; color:white; font-size:13px; font-weight:600; cursor:pointer; font-family:inherit; }
  .install-btn:active { transform:scale(0.96); }
  .dismiss-btn { font-size:18px; color:var(--text-faint); background:none; border:none; cursor:pointer; padding:4px; }
</style>
</head>
<body>
<div class="app">

  <!-- HEADER -->
  <div class="header">
    <div class="header-left">
      <div class="logo-dot"></div>
      <div class="app-name">Stealth<span>AI</span></div>
      <div class="badge badge-gemini">Gemini 2.5</div>
    </div>
    <div class="settings-btn" id="settingsBtn">‚öôÔ∏è</div>
  </div>

  <!-- INSTALL BANNER -->
  <div class="install-banner" id="installBanner">
    <div class="install-text"><strong>Add to Home Screen</strong> for app experience</div>
    <button class="install-btn" id="installBtn">Install</button>
    <button class="dismiss-btn" id="dismissBtn">‚úï</button>
  </div>

  <!-- SETUP SCREEN -->
  <div id="setup-screen">
    <div class="setup-hero">
      <span class="setup-emoji">ü•∑</span>
      <div class="setup-title">StealthAI</div>
      <div class="setup-sub">AI interview assistant powered by<br><strong>Google Gemini ‚Äî completely free</strong></div>
    </div>

    <div class="info-card">
      <div class="info-card-title">Get Free API Key</div>
      <div class="info-card-body">
        1. Open <code>aistudio.google.com/apikey</code><br>
        2. Sign in with Google<br>
        3. Tap <strong>Create API Key</strong> ‚Üí Copy it
      </div>
    </div>

    <div class="input-group">
      <label class="input-label">Paste your Gemini API Key</label>
      <input type="password" class="text-input" id="apiKeyInput" placeholder="AIzaSy..." autocomplete="off" spellcheck="false"/>
    </div>

    <div class="input-group">
      <label class="input-label">Interview Role / Context (optional)</label>
      <input type="text" class="text-input" id="contextSetup" placeholder="e.g. Azure DevOps engineer interview"/>
    </div>

    <button class="btn-primary" id="saveApiBtn">Start StealthAI ‚Üí</button>

    <div class="hint-text">
      Your API key is stored only on this device.<br>
      Never shared or saved to any server.
    </div>
  </div>

  <!-- CHAT SCREEN -->
  <div id="chat-screen">

    <!-- Audio Bar -->
    <div class="audio-bar">
      <button class="mic-btn" id="micBtn">
        <div class="rec-dot" id="recDot"></div>
        <span id="micLabel">üé§ Listen</span>
      </button>
      <div class="audio-info">
        <div class="audio-status" id="audioStatus">tap to auto-answer questions</div>
      </div>
    </div>

    <!-- Context -->
    <div class="context-bar">
      <span class="context-label">Role</span>
      <input type="text" class="context-input" id="contextInput" placeholder="e.g. Azure DevOps interview..."/>
    </div>

    <!-- Messages -->
    <div class="messages" id="messages">
      <div class="welcome">
        <span class="welcome-emoji">ü•∑</span>
        <h3>StealthAI Ready</h3>
        <p>Tap <strong>üé§ Listen</strong> to auto-answer<br>your interviewer's questions.<br>Or type below manually.</p>
      </div>
    </div>

    <!-- Quick chips -->
    <div class="quick-scroll">
      <button class="quick-chip" data-p="How would you answer this interview question: ">üéØ Interview</button>
      <button class="quick-chip" data-p="Explain in detail with examples: ">üí° Explain</button>
      <button class="quick-chip" data-p="Write complete code for: ">üíª Code</button>
      <button class="quick-chip" data-p="List all key points about: ">üìã Key Points</button>
      <button class="quick-chip" data-p="Give a quick concise answer for: ">‚ö° Quick</button>
      <button class="quick-chip" data-p="Debug and fix this: ">üêõ Debug</button>
      <button class="quick-chip" data-p="Compare and contrast: ">‚öñÔ∏è Compare</button>
    </div>

    <!-- Input -->
    <div class="input-area">
      <textarea class="chat-textarea" id="chatInput" placeholder="Type question..." rows="1"></textarea>
      <button class="send-btn" id="sendBtn">‚Üë</button>
    </div>

    <!-- Status -->
    <div class="status-bar">
      <div class="status-left">
        <div class="status-dot"></div>
        <span class="status-text" id="statusText">ready</span>
      </div>
      <span class="msg-count" id="msgCount">0 exchanges</span>
    </div>

  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let apiKey = '';
let context = '';
let history = [];
let isLoading = false;
let exchanges = 0;

// Audio
let mediaRecorder = null;
let isListening = false;
let audioChunks = [];
let stream = null;
let chunkTimer = null;

// PWA install
let deferredPrompt = null;

// ‚îÄ‚îÄ‚îÄ DOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const setupScreen  = document.getElementById('setup-screen');
const chatScreen   = document.getElementById('chat-screen');
const apiKeyInput  = document.getElementById('apiKeyInput');
const contextSetup = document.getElementById('contextSetup');
const saveApiBtn   = document.getElementById('saveApiBtn');
const messagesEl   = document.getElementById('messages');
const chatInput    = document.getElementById('chatInput');
const sendBtn      = document.getElementById('sendBtn');
const contextInput = document.getElementById('contextInput');
const statusText   = document.getElementById('statusText');
const msgCountEl   = document.getElementById('msgCount');
const micBtn       = document.getElementById('micBtn');
const recDot       = document.getElementById('recDot');
const micLabel     = document.getElementById('micLabel');
const audioStatus  = document.getElementById('audioStatus');
const installBanner= document.getElementById('installBanner');
const installBtn   = document.getElementById('installBtn');
const dismissBtn   = document.getElementById('dismissBtn');

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(()=>{});
}

const savedKey = localStorage.getItem('sai_key');
const savedCtx = localStorage.getItem('sai_ctx');
if (savedKey) {
  apiKey = savedKey;
  context = savedCtx || '';
  showChat();
}

// PWA install prompt
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  installBanner.classList.add('show');
});

installBtn.onclick = async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const result = await deferredPrompt.userChoice;
  deferredPrompt = null;
  installBanner.classList.remove('show');
};
dismissBtn.onclick = () => installBanner.classList.remove('show');

// ‚îÄ‚îÄ‚îÄ Setup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
saveApiBtn.onclick = () => {
  const key = apiKeyInput.value.trim();
  if (key.length < 15) {
    apiKeyInput.classList.add('error');
    setTimeout(() => apiKeyInput.classList.remove('error'), 1500);
    return;
  }
  apiKey = key;
  context = contextSetup.value.trim();
  localStorage.setItem('sai_key', key);
  localStorage.setItem('sai_ctx', context);
  showChat();
};
apiKeyInput.addEventListener('keydown', e => { if(e.key==='Enter') saveApiBtn.click(); });

document.getElementById('settingsBtn').onclick = () => {
  stopListening();
  apiKey = ''; context = '';
  localStorage.removeItem('sai_key');
  history = []; exchanges = 0;
  setupScreen.style.display = 'flex';
  chatScreen.classList.remove('active');
  apiKeyInput.value = '';
  contextSetup.value = '';
};

function showChat() {
  setupScreen.style.display = 'none';
  chatScreen.classList.add('active');
  if (context) contextInput.value = context;
}

// ‚îÄ‚îÄ‚îÄ Quick chips ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.quick-chip').forEach(btn => {
  btn.onclick = () => {
    chatInput.value = btn.dataset.p;
    chatInput.focus();
    autoResize();
  };
});

// ‚îÄ‚îÄ‚îÄ Textarea ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function autoResize() {
  chatInput.style.height = '42px';
  chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
}
chatInput.addEventListener('input', autoResize);
chatInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); if(!isLoading) sendMessage(); }
});
sendBtn.onclick = () => { if (!isLoading) sendMessage(); };

// ‚îÄ‚îÄ‚îÄ AUDIO LISTENING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
micBtn.onclick = () => { if(isListening) stopListening(); else startListening(); };

async function startListening() {
  try {
    audioStatus.textContent = 'requesting microphone...';
    audioStatus.className = 'audio-status';

    stream = await navigator.mediaDevices.getUserMedia({
      audio: {
        echoCancellation: false,
        noiseSuppression: false,
        autoGainControl: false,
        sampleRate: 16000,
        channelCount: 1
      }
    });

    isListening = true;
    micBtn.classList.add('recording');
    recDot.classList.add('pulse');
    micLabel.textContent = '‚èπ Stop';
    audioStatus.className = 'audio-status active';
    audioStatus.textContent = 'üî¥ listening for questions...';
    statusText.textContent = 'listening mode';

    recordChunk();

  } catch(err) {
    audioStatus.textContent = '‚ö† mic access denied: ' + err.message;
    audioStatus.className = 'audio-status';
  }
}

function recordChunk() {
  if (!isListening || !stream) return;
  audioChunks = [];

  const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
    ? 'audio/webm;codecs=opus'
    : MediaRecorder.isTypeSupported('audio/webm')
    ? 'audio/webm'
    : 'audio/ogg';

  try {
    mediaRecorder = new MediaRecorder(stream, { mimeType });
  } catch(e) {
    mediaRecorder = new MediaRecorder(stream);
  }

  mediaRecorder.ondataavailable = e => { if(e.data && e.data.size > 0) audioChunks.push(e.data); };

  mediaRecorder.onstop = async () => {
    if (!isListening) return;
    const mimeUsed = mediaRecorder.mimeType || 'audio/webm';
    const blob = new Blob(audioChunks, { type: mimeUsed });

    if (blob.size < 3000) {
      audioStatus.textContent = 'üî¥ listening... (silence)';
      recordChunk();
      return;
    }

    audioStatus.className = 'audio-status processing';
    audioStatus.textContent = '‚ö° transcribing...';

    try {
      const base64 = await blobToBase64(blob);
      const mimeForApi = mimeUsed.split(';')[0];
      const transcript = await callGeminiAudio(base64, mimeForApi);
      const cleaned = transcript.trim();

      if (!cleaned || cleaned.length < 5) {
        audioStatus.className = 'audio-status active';
        audioStatus.textContent = 'üî¥ listening... (no speech detected)';
        recordChunk();
        return;
      }

      appendHeard(cleaned);
      audioStatus.textContent = 'üî¥ generating answer...';
      await autoAnswer(cleaned);

    } catch(err) {
      console.error(err);
      audioStatus.textContent = '‚ö† ' + String(err).substring(0, 50);
    }

    if (isListening) {
      audioStatus.className = 'audio-status active';
      audioStatus.textContent = 'üî¥ listening for next question...';
      recordChunk();
    }
  };

  mediaRecorder.start();
  // 8 second chunks
  chunkTimer = setTimeout(() => {
    if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
  }, 8000);
}

function stopListening() {
  isListening = false;
  clearTimeout(chunkTimer);
  if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
  micBtn.classList.remove('recording');
  recDot.classList.remove('pulse');
  micLabel.textContent = 'üé§ Listen';
  audioStatus.className = 'audio-status';
  audioStatus.textContent = 'tap to auto-answer questions';
  statusText.textContent = 'ready';
}

function blobToBase64(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

// ‚îÄ‚îÄ‚îÄ Gemini API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function callGemini(messages, ctx) {
  const contents = messages.map(m => ({
    role: m.role === 'assistant' ? 'model' : 'user',
    parts: [{ text: m.content }]
  }));

  const systemCtx = ctx || contextInput.value.trim();
  if (systemCtx) {
    contents.unshift({ role: 'user', parts: [{ text: `You are an expert AI assistant helping someone in a ${systemCtx}. Give thorough, detailed, well-structured answers with examples. For technical questions show working code. Do not cut your answer short. Be comprehensive.` }] });
    contents.splice(1, 0, { role: 'model', parts: [{ text: 'Understood. I will give detailed, comprehensive answers with examples and code where relevant.' }] });
  }

  const res = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents,
        generationConfig: { temperature: 0.7, maxOutputTokens: 2048 }
      })
    }
  );
  const data = await res.json();
  if (data.error) throw new Error(data.error.message);
  return data.candidates[0].content.parts[0].text;
}

async function callGeminiAudio(base64, mimeType) {
  const res = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          role: 'user',
          parts: [
            { inline_data: { mime_type: mimeType, data: base64 } },
            { text: 'Transcribe exactly what is said in this audio. Return only the spoken words. If silence or unclear, return empty string.' }
          ]
        }],
        generationConfig: { temperature: 0, maxOutputTokens: 512 }
      })
    }
  );
  const data = await res.json();
  if (data.error) throw new Error(data.error.message);
  return data.candidates[0].content.parts[0].text;
}

async function autoAnswer(question) {
  const prompt = `The interviewer just asked: "${question}"\n\nGive a complete, detailed answer I can speak naturally. Include relevant examples, explanations, and code if needed. Be thorough.`;
  const messages = [...history, { role: 'user', content: prompt }];
  const typingId = addTyping();
  statusText.textContent = 'generating answer...';
  try {
    const response = await callGemini(messages);
    removeTyping(typingId);
    history.push({ role:'user', content:prompt });
    history.push({ role:'assistant', content:response });
    if (history.length > 20) history = history.slice(-20);
    appendMsg('ai', response);
    exchanges++; msgCountEl.textContent = `${exchanges} exchanges`;
  } catch(err) {
    removeTyping(typingId);
    appendError(String(err));
  }
  statusText.textContent = 'ready';
}

async function sendMessage() {
  const text = chatInput.value.trim();
  if (!text || !apiKey) return;
  chatInput.value = ''; autoResize();
  isLoading = true; sendBtn.disabled = true;
  appendMsg('user', text);
  const typingId = addTyping();
  statusText.textContent = 'thinking...';
  const messages = [...history, { role:'user', content:text }];
  try {
    const response = await callGemini(messages);
    removeTyping(typingId);
    history.push({ role:'user', content:text });
    history.push({ role:'assistant', content:response });
    if (history.length > 20) history = history.slice(-20);
    appendMsg('ai', response);
    exchanges++; msgCountEl.textContent = `${exchanges} exchanges`;
    statusText.textContent = 'ready';
  } catch(err) {
    removeTyping(typingId);
    appendError(String(err));
    statusText.textContent = '‚ö† error';
  }
  isLoading = false; sendBtn.disabled = false;
}

// ‚îÄ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function appendHeard(text) {
  clearWelcome();
  const div = document.createElement('div');
  div.className = 'message heard';
  div.innerHTML = `<div class="msg-label">üé§ interviewer said</div><div class="msg-bubble">${esc(text)}</div>`;
  messagesEl.appendChild(div); scrollDown();
}

function appendMsg(role, content) {
  clearWelcome();
  const div = document.createElement('div');
  div.className = `message ${role}`;
  const label = role === 'user' ? 'you' : 'ü§ñ answer';
  div.innerHTML = `<div class="msg-label">${label}</div><div class="msg-bubble">${fmt(content)}</div>`;
  messagesEl.appendChild(div); scrollDown();
}

function fmt(text) {
  text = text.replace(/```(\w*)\n?([\s\S]*?)```/g, (_,l,c) => `<pre><code>${esc(c.trim())}</code></pre>`);
  text = text.replace(/`([^`]+)`/g, (_,c) => `<code>${esc(c)}</code>`);
  text = text.replace(/\*\*([^*\n]+)\*\*/g, '<strong>$1</strong>');
  text = text.replace(/\*([^*\n]+)\*/g, '<em>$1</em>');
  return text;
}
function esc(t) { return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function addTyping() {
  const id = 'tp' + Date.now();
  const div = document.createElement('div');
  div.id = id; div.className = 'typing-wrap';
  div.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div><span class="typing-text">answering...</span>';
  messagesEl.appendChild(div); scrollDown(); return id;
}
function removeTyping(id) { const el = document.getElementById(id); if(el) el.remove(); }
function appendError(msg) {
  const div = document.createElement('div');
  div.className = 'error-bubble';
  div.textContent = '‚ö† ' + msg;
  messagesEl.appendChild(div); scrollDown();
}
function clearWelcome() { const w = messagesEl.querySelector('.welcome'); if(w) w.remove(); }
function scrollDown() { setTimeout(() => { messagesEl.scrollTop = messagesEl.scrollHeight; }, 50); }
</script>
</body>
</html>
