<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0a0f">
<title>StealthAI</title>
<link rel="manifest" href="manifest.json">
<style>
:root{
  --bg:#0a0a0f;--s1:#0d0d15;--s2:#141420;
  --border:#ffffff0d;--ba:#ffffff18;
  --accent:#7c6cfc;--a2:#4ecdc4;--aglow:#7c6cfc20;
  --text:#eeeef5;--dim:#7777aa;--faint:#33334a;
  --aibg:#0b0b16;--ubg:#131325;
  --ok:#4ecca3;--err:#ff6b6b;--heard:#ffaa44;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100%;background:var(--bg);color:var(--text);
  font-family:-apple-system,'SF Pro Text','Segoe UI',sans-serif;
  overflow:hidden;-webkit-user-select:none;user-select:none}
.app{width:100%;height:100dvh;display:flex;flex-direction:column;
  padding-top:env(safe-area-inset-top,0);padding-bottom:env(safe-area-inset-bottom,0)}

/* HEADER â€” compact */
.hdr{display:flex;align-items:center;justify-content:space-between;
  padding:8px 14px;background:linear-gradient(180deg,#ffffff06,transparent);
  border-bottom:1px solid var(--border);flex-shrink:0;min-height:44px}
.hl{display:flex;align-items:center;gap:8px}
.pulsedot{width:8px;height:8px;border-radius:50%;background:var(--accent);
  box-shadow:0 0 8px var(--accent);animation:pulse 2s infinite;flex-shrink:0}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
.appname{font-size:16px;font-weight:800;letter-spacing:-0.3px}
.appname em{color:var(--accent);font-style:normal}
.badges{display:flex;gap:5px;align-items:center}
.badge{font-size:9px;padding:2px 7px;border-radius:20px;font-weight:700;letter-spacing:0.04em}
.b-live{background:#ff444415;color:#ff8888;border:1px solid #ff444435;animation:lb 2s infinite}
@keyframes lb{0%,100%{border-color:#ff444435}50%{border-color:#ff4444a0}}
.b-vad{background:var(--aglow);color:var(--accent);border:1px solid #7c6cfc30;display:none}
.b-vad.on{display:inline-block}
.hr2{display:flex;gap:6px}
.ibtn{width:32px;height:32px;border-radius:50%;background:var(--s2);
  border:1px solid var(--ba);display:flex;align-items:center;justify-content:center;
  font-size:14px;cursor:pointer;transition:all 0.15s}
.ibtn:active{transform:scale(0.85)}

/* TABS â€” compact */
.tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--s1)}
.tab{flex:1;padding:8px 0;text-align:center;font-size:11px;font-weight:700;
  color:var(--faint);cursor:pointer;border-bottom:2px solid transparent;
  transition:all 0.2s;letter-spacing:0.03em;text-transform:uppercase}
.tab.on{color:var(--accent);border-color:var(--accent)}

.scr{display:none;flex:1;flex-direction:column;overflow:hidden}
.scr.on{display:flex}

/* AUDIO BAR â€” ultra compact */
.abar{padding:7px 12px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:8px;flex-shrink:0;background:#ffffff01}
.micbtn{display:flex;align-items:center;gap:6px;padding:7px 13px;border-radius:50px;
  border:1.5px solid var(--ba);background:var(--s2);color:var(--dim);
  font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;
  flex-shrink:0;font-family:inherit;transition:all 0.2s}
.micbtn.rec{background:#ff444412;border-color:#ff444450;color:#ff7777;animation:rg 1.2s infinite}
@keyframes rg{0%,100%{box-shadow:0 0 0 0 #ff444420}50%{box-shadow:0 0 0 7px #ff444400}}
.rdot{width:7px;height:7px;border-radius:50%;background:currentColor;flex-shrink:0}
.rdot.beat{animation:bt 0.75s ease-in-out infinite}
@keyframes bt{0%,100%{transform:scale(1)}50%{transform:scale(1.7)}}
.ainfo{flex:1;min-width:0;display:flex;align-items:center;gap:8px}
.ast{font-size:11px;color:var(--faint);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
.ast.live{color:#ff7777}.ast.proc{color:var(--a2)}.ast.ok{color:var(--ok)}

/* Live waveform â€” tiny */
.wave{display:flex;align-items:center;gap:1.5px;height:14px;flex-shrink:0}
.wbar{width:2.5px;border-radius:2px;background:#ff777788;min-height:2px}

/* VAD volume bar */
.vadmini{display:flex;align-items:center;gap:5px;flex-shrink:0}
.vtrack{width:50px;height:3px;background:var(--s2);border-radius:2px;overflow:hidden}
.vfill{height:100%;border-radius:2px;background:var(--ok);transition:width 0.06s}

/* Role bar â€” single line */
.rolebar{padding:5px 12px;border-bottom:1px solid var(--border);
  display:flex;gap:7px;align-items:center;flex-shrink:0}
.rolbl{font-size:9px;color:var(--faint);font-weight:700;text-transform:uppercase;
  letter-spacing:0.1em;white-space:nowrap}
.roinp{flex:1;padding:5px 10px;background:var(--s2);border:1px solid var(--border);
  border-radius:8px;color:var(--text);font-size:12px;outline:none;
  -webkit-user-select:text;user-select:text;font-family:inherit}
.roinp:focus{border-color:var(--accent)}
.roinp::placeholder{color:var(--faint)}

/* MESSAGES â€” maximum space */
.msgs{flex:1;overflow-y:auto;padding:10px 12px;
  display:flex;flex-direction:column;gap:10px;-webkit-overflow-scrolling:touch}
.msgs::-webkit-scrollbar{display:none}
.msg{display:flex;flex-direction:column;gap:2px;animation:mi 0.2s ease}
@keyframes mi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.mlbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;padding:0 2px}
.msg.ai .mlbl{color:var(--accent)}
.msg.user .mlbl{color:var(--a2);text-align:right}
.msg.heard .mlbl{color:var(--heard)}

/* AI bubble â€” large, readable */
.mbub{padding:11px 14px;border-radius:14px;font-size:14.5px;line-height:1.7;
  color:var(--text);word-wrap:break-word;-webkit-user-select:text;user-select:text}
.msg.ai .mbub{background:var(--aibg);border:1px solid var(--border);
  border-bottom-left-radius:4px;border-left:3px solid var(--accent)}
.msg.user .mbub{background:var(--ubg);border:1px solid var(--ba);
  border-bottom-right-radius:4px;align-self:flex-end;max-width:85%;
  border-right:3px solid var(--a2);font-size:13px}
.msg.heard .mbub{background:#ffaa4408;border:1px solid #ffaa4422;
  border-bottom-left-radius:4px;border-left:3px solid var(--heard);
  color:var(--dim);font-style:italic;font-size:12px;padding:8px 12px}
.msg.skipped .mbub{background:#ffffff05;border:1px solid var(--border);
  color:var(--faint);font-size:11px;padding:6px 10px;border-radius:8px}

/* Question type tag */
.qtag{display:inline-flex;align-items:center;gap:4px;font-size:9px;font-weight:700;
  padding:2px 8px;border-radius:20px;margin-bottom:6px;letter-spacing:0.06em;text-transform:uppercase}
.qt-tech{background:#4ecdc418;color:var(--a2);border:1px solid #4ecdc430}
.qt-beh{background:#7c6cfc18;color:#b0a0ff;border:1px solid #7c6cfc30}
.qt-hr{background:#ffd70018;color:#ffd060;border:1px solid #ffd70030}
.qt-cod{background:#ff8c4218;color:#ffa060;border:1px solid #ff8c4230}
.qt-gen{background:#ffffff08;color:var(--dim);border:1px solid var(--ba)}

.mbub code{font-family:'SF Mono',monospace;font-size:12px;background:#ffffff0a;
  padding:2px 6px;border-radius:4px;color:var(--a2)}
.mbub pre{background:#070710;border:1px solid var(--border);border-radius:10px;
  padding:11px 13px;margin:8px 0;overflow-x:auto;font-family:'SF Mono',monospace;
  font-size:12px;line-height:1.55;color:#c8c8e8;white-space:pre;-webkit-overflow-scrolling:touch}

/* Confidence bar */
.cbar{display:flex;align-items:center;gap:6px;margin-top:8px;
  padding-top:7px;border-top:1px solid var(--border)}
.clbl{font-size:9px;color:var(--faint);flex-shrink:0}
.ctrack{flex:1;height:3px;background:var(--s2);border-radius:2px;overflow:hidden}
.cfill{height:100%;border-radius:2px;transition:width 0.6s ease}
.cpct{font-size:9px;font-weight:700;flex-shrink:0}

/* Latency badge */
.latency{font-size:9px;color:var(--faint);margin-top:4px;text-align:right}

/* Typing */
.twrap{display:flex;align-items:center;gap:8px;padding:8px 12px}
.tdots{display:flex;gap:3px}
.tdots span{width:5px;height:5px;background:var(--accent);border-radius:50%;
  animation:td 1.2s infinite;opacity:0.4}
.tdots span:nth-child(2){animation-delay:0.2s}
.tdots span:nth-child(3){animation-delay:0.4s}
@keyframes td{0%,100%{transform:translateY(0);opacity:0.4}50%{transform:translateY(-4px);opacity:1}}
.ttxt{font-size:11px;color:var(--faint)}

/* Chips â€” scrollable */
.chips{padding:6px 10px;border-top:1px solid var(--border);overflow-x:auto;
  display:flex;gap:6px;flex-shrink:0;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.chips::-webkit-scrollbar{display:none}
.chip{padding:5px 11px;background:var(--s2);border:1px solid var(--border);
  border-radius:20px;color:var(--dim);font-size:11px;font-weight:500;
  white-space:nowrap;cursor:pointer;font-family:inherit;flex-shrink:0;transition:all 0.15s}
.chip:active{background:var(--aglow);border-color:var(--accent);color:var(--accent);transform:scale(0.93)}

/* Input â€” compact */
.inprow{padding:7px 11px 8px;border-top:1px solid var(--border);
  display:flex;gap:8px;align-items:flex-end;flex-shrink:0}
.chatta{flex:1;min-height:36px;max-height:90px;padding:8px 13px;background:var(--s2);
  border:1.5px solid var(--ba);border-radius:20px;color:var(--text);font-size:14px;
  font-family:inherit;outline:none;resize:none;line-height:1.4;overflow-y:auto;
  -webkit-user-select:text;user-select:text;transition:border-color 0.2s}
.chatta:focus{border-color:var(--accent)}
.chatta::placeholder{color:var(--faint)}
.sndbtn{width:36px;height:36px;background:var(--accent);border:none;border-radius:50%;
  color:#fff;font-size:17px;cursor:pointer;flex-shrink:0;display:flex;
  align-items:center;justify-content:center;box-shadow:0 2px 10px #7c6cfc40;transition:all 0.2s}
.sndbtn:active{transform:scale(0.86)}
.sndbtn:disabled{background:var(--s2);color:var(--faint);box-shadow:none}

/* Status â€” single line */
.sbar{padding:4px 13px 5px;display:flex;justify-content:space-between;
  align-items:center;flex-shrink:0;border-top:1px solid var(--border)}
.sl{display:flex;gap:5px;align-items:center}
.sdot{width:5px;height:5px;border-radius:50%;background:var(--ok);box-shadow:0 0 5px var(--ok)}
.stxt,.scnt{font-size:10px;color:var(--faint)}

/* SETUP & RESUME */
.scroll-wrap{flex:1;overflow-y:auto;padding:14px;
  display:flex;flex-direction:column;gap:12px;-webkit-overflow-scrolling:touch}
.card{background:var(--s2);border:1px solid var(--ba);border-radius:14px;padding:13px 15px}
.ctitle{font-size:10px;color:var(--accent);font-weight:700;text-transform:uppercase;
  letter-spacing:0.12em;margin-bottom:8px}
.cbody{font-size:13px;color:var(--dim);line-height:1.6}
.cbody code{font-family:'SF Mono',monospace;color:var(--a2);background:#ffffff08;
  padding:2px 5px;border-radius:3px;font-size:11px}
.flbl{font-size:11px;color:var(--dim);font-weight:600;margin-bottom:6px;display:block}
.finp{width:100%;padding:12px 14px;background:var(--s2);border:1.5px solid var(--ba);
  border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none;
  transition:border-color 0.2s,box-shadow 0.2s;-webkit-user-select:text;user-select:text}
.finp:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--aglow)}
.finp::placeholder{color:var(--faint)}
.finp.err{border-color:var(--err)}
textarea.finp{resize:none;min-height:100px;line-height:1.55}
.btn-go{width:100%;padding:14px;background:linear-gradient(135deg,var(--accent),#5040c8);
  border:none;border-radius:13px;color:#fff;font-size:15px;font-weight:700;
  cursor:pointer;box-shadow:0 5px 20px #7c6cfc35;font-family:inherit;transition:all 0.2s}
.btn-go:active{transform:scale(0.97)}
.hint{font-size:11px;color:var(--faint);text-align:center;line-height:1.7}
.res-saved{font-size:11px;color:var(--ok);margin-top:4px;text-align:right}
.welcome{text-align:center;padding:28px 20px;color:var(--faint)}
.wico{font-size:40px;margin-bottom:10px;display:block;filter:drop-shadow(0 0 12px #7c6cfc80)}
.welcome h3{font-size:16px;font-weight:700;color:var(--dim);margin-bottom:8px}
.welcome p{font-size:13px;line-height:1.8}
.welcome strong{color:var(--dim);-webkit-text-fill-color:var(--dim)}
.errbub{background:#ff6b6b0d;border:1px solid #ff6b6b25;border-radius:10px;
  padding:9px 12px;color:var(--err);font-size:12px}

/* range input */
input[type=range]{width:100%;accent-color:var(--accent);margin:4px 0}
</style>
</head>
<body>
<div class="app">

<!-- HEADER -->
<div class="hdr">
  <div class="hl">
    <div class="pulsedot"></div>
    <div class="appname">Stealth<em>AI</em></div>
    <div class="badges">
      <div class="badge b-live">â— LIVE</div>
      <div class="badge b-vad" id="vadBadge">VAD</div>
    </div>
  </div>
  <div class="hr2">
    <div class="ibtn" id="clearBtn" title="Clear">ğŸ—‘</div>
    <div class="ibtn" id="settingsBtn" title="Setup">âš™ï¸</div>
  </div>
</div>

<!-- TABS -->
<div class="tabs">
  <div class="tab on" data-tab="interview">ğŸ¯ Interview</div>
  <div class="tab" data-tab="resume">ğŸ“„ Resume</div>
  <div class="tab" data-tab="setup">ğŸ”‘ Setup</div>
</div>

<!-- â•â• INTERVIEW â•â• -->
<div class="scr on" id="tab-interview">

  <div class="abar">
    <button class="micbtn" id="micBtn">
      <div class="rdot" id="rdot"></div>
      <span id="micLbl">ğŸ¤ Listen</span>
    </button>
    <div class="ainfo">
      <div class="ast" id="ast">tap to start</div>
      <div class="vadmini" id="vadMini" style="display:none">
        <div class="vtrack"><div class="vfill" id="vfill" style="width:0%"></div></div>
        <div class="wave" id="wave"></div>
      </div>
    </div>
  </div>

  <div class="rolebar">
    <span class="rolbl">Role</span>
    <input type="text" class="roinp" id="roleInput" placeholder="Azure DevOps Engineer, 6 years exp..."/>
  </div>

  <div class="msgs" id="msgs">
    <div class="welcome">
      <span class="wico">ğŸ¥·</span>
      <h3>StealthAI Ready</h3>
      <p>
        Tap <strong>ğŸ¤ Listen</strong> for continuous VAD.<br>
        Auto-detects questions, filters noise,<br>
        generates Parakeet-style answers instantly.<br><br>
        Add your <strong>resume</strong> for personalized answers.
      </p>
    </div>
  </div>

  <div class="chips">
    <button class="chip" data-p="Tell me about yourself.">ğŸ‘¤ Intro</button>
    <button class="chip" data-p="Explain microservices architecture.">ğŸ’¡ Technical</button>
    <button class="chip" data-p="Tell me about a challenge you overcame.">â­ STAR</button>
    <button class="chip" data-p="Write code for a binary search.">ğŸ’» Code</button>
    <button class="chip" data-p="What is your greatest strength?">ğŸ’ª Strength</button>
    <button class="chip" data-p="Why do you want this role?">ğŸ¢ Fit</button>
    <button class="chip" data-p="Where do you see yourself in 5 years?">ğŸ¯ Growth</button>
    <button class="chip" data-p="What is the difference between Docker and Kubernetes?">âš–ï¸ Diff</button>
  </div>

  <div class="inprow">
    <textarea class="chatta" id="chatInput" placeholder="Type question manually..." rows="1"></textarea>
    <button class="sndbtn" id="sendBtn">â†‘</button>
  </div>
  <div class="sbar">
    <div class="sl"><div class="sdot"></div><span class="stxt" id="stxt">ready</span></div>
    <span class="scnt" id="scnt">0 answers</span>
  </div>
</div>

<!-- â•â• RESUME â•â• -->
<div class="scr" id="tab-resume">
  <div class="scroll-wrap">
    <div class="card">
      <div class="ctitle">ğŸ“„ Resume &amp; Skills</div>
      <div class="cbody">Paste your resume below. StealthAI uses this to personalize every answer to YOUR background â€” just like Parakeet AI.</div>
    </div>
    <div>
      <label class="flbl">Your Resume / Skills / Experience</label>
      <textarea class="finp" id="resumeInput" rows="14"
        placeholder="Example:&#10;Name: Your Name&#10;Total Exp: 6.5 years&#10;Current: TCS â€” Azure DevOps for Tata Neo app&#10;  - AKS, VMs, Web Apps, Azure DevOps pipelines&#10;Previous: LTI Mindtree â€” Cloud infra, Terraform&#10;Skills: Terraform, AKS, Docker, Kubernetes,&#10;  Azure DevOps, CI/CD, PowerShell, YAML,&#10;  Azure Policy, RBAC, Cost Mgmt&#10;Achievements:&#10;  - Reduced cloud costs by 30%&#10;  - Zero downtime deployments&#10;Certs: AZ-104&#10;Education: B.Tech Computer Science"></textarea>
      <div class="res-saved" id="resSaved" style="display:none">âœ“ Saved to device</div>
    </div>
    <button class="btn-go" id="saveResBtn">Save Resume â†’</button>
    <div class="hint">Stored locally on your device only.</div>
  </div>
</div>

<!-- â•â• SETUP â•â• -->
<div class="scr" id="tab-setup">
  <div class="scroll-wrap">
    <div class="card">
      <div class="ctitle">ğŸ”‘ Gemini API Key</div>
      <div class="cbody">Get free key at <code>aistudio.google.com/apikey</code><br>Sign in â†’ Create API Key â†’ Copy</div>
    </div>
    <div>
      <label class="flbl">API Key</label>
      <input type="password" class="finp" id="apiKeyInput" placeholder="AIzaSy..." autocomplete="off"/>
    </div>
    <button class="btn-go" id="saveApiBtn">Save Key â†’</button>

    <div class="card">
      <div class="ctitle">âš¡ Latency Settings</div>
      <div class="cbody">
        <div style="margin-bottom:10px">
          <strong style="color:var(--text);font-size:12px">VAD Silence Threshold</strong><br>
          <span style="font-size:11px">How long silence before processing (lower = faster)</span>
          <input type="range" id="vadThresh" min="400" max="1500" step="50" value="700">
          <span style="font-size:11px;color:var(--a2)">Current: <span id="vadVal">700</span>ms</span>
        </div>
        <div>
          <strong style="color:var(--text);font-size:12px">Min Speech Duration</strong><br>
          <span style="font-size:11px">Skip audio shorter than this (reduces false triggers)</span>
          <input type="range" id="minSpeech" min="500" max="3000" step="100" value="1000">
          <span style="font-size:11px;color:var(--a2)">Current: <span id="minSpeechVal">1000</span>ms</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="ctitle">ğŸ¯ Question Detection</div>
      <div class="cbody" style="font-size:12px">
        <strong style="color:var(--text)">Pattern matching enabled:</strong><br>
        What Â· How Â· Explain Â· Describe Â· Why Â· Tell me Â· Define Â· Compare Â· Difference Â· Can you Â· Walk me through Â· Give me Â· What is Â· What are<br><br>
        <strong style="color:var(--text)">2-step classifier:</strong><br>
        Step 1: Is this an interview question? (fast, cheap)<br>
        Step 2: Only if YES â†’ generate full answer
      </div>
    </div>

    <div class="card">
      <div class="ctitle">ğŸ“± Install App</div>
      <div class="cbody">Android: Browser â‹® â†’ Add to Home Screen<br>iPhone: Share â†’ Add to Home Screen</div>
    </div>
    <div class="hint">All data stored on device only.</div>
  </div>
</div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let apiKey      = localStorage.getItem('sai_key') || '';
let resumeText  = localStorage.getItem('sai_resume') || '';
let vadMs       = parseInt(localStorage.getItem('sai_vad') || '700');
let minSpeechMs = parseInt(localStorage.getItem('sai_minspeech') || '1000');
let history     = [];
let answers     = 0;
let totalLatency= 0;

// Audio
let audioCtx    = null;
let analyser    = null;
let micStream   = null;
let isListening = false;
let activeRec   = null;
let rollingChunks = [];
let rollingMime = 'audio/webm';

// VAD
let isSpeaking    = false;
let silenceStart  = null;
let speechStart   = null;
let processingQ   = Promise.resolve();

// Question pattern detection â€” no diarization needed
const QUESTION_PATTERNS = [
  /^what\b/i, /^how\b/i, /^explain\b/i, /^describe\b/i, /^why\b/i,
  /^tell me\b/i, /^define\b/i, /^compare\b/i, /^difference\b/i,
  /^can you\b/i, /^could you\b/i, /^walk me\b/i, /^give me\b/i,
  /^what is\b/i, /^what are\b/i, /^have you\b/i, /^do you\b/i,
  /^when\b/i, /^where\b/i, /^who\b/i, /^which\b/i,
  /\?$/, /\bexperience\b/i, /\bproject\b/i, /\bchallenge\b/i,
  /\bstrength\b/i, /\bweakness\b/i, /\barchitecture\b/i
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const msgsEl    = document.getElementById('msgs');
const chatInput = document.getElementById('chatInput');
const sendBtn   = document.getElementById('sendBtn');
const roleInput = document.getElementById('roleInput');
const stxt      = document.getElementById('stxt');
const scnt      = document.getElementById('scnt');
const micBtn    = document.getElementById('micBtn');
const rdot      = document.getElementById('rdot');
const micLbl    = document.getElementById('micLbl');
const ast       = document.getElementById('ast');
const vadMini   = document.getElementById('vadMini');
const vfill     = document.getElementById('vfill');
const vadBadge  = document.getElementById('vadBadge');

// Init values
if (apiKey) document.getElementById('apiKeyInput').value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
if (resumeText) document.getElementById('resumeInput').value = resumeText;
roleInput.value = localStorage.getItem('sai_role') || '';

const vadSlider = document.getElementById('vadThresh');
const vadValEl  = document.getElementById('vadVal');
vadSlider.value = vadMs; vadValEl.textContent = vadMs;
vadSlider.oninput = () => { vadMs = +vadSlider.value; vadValEl.textContent = vadMs; localStorage.setItem('sai_vad', vadMs); };

const minSlider = document.getElementById('minSpeech');
const minValEl  = document.getElementById('minSpeechVal');
minSlider.value = minSpeechMs; minValEl.textContent = minSpeechMs;
minSlider.oninput = () => { minSpeechMs = +minSlider.value; minValEl.textContent = minSpeechMs; localStorage.setItem('sai_minspeech', minSpeechMs); };

// Build waveform
const waveEl = document.getElementById('wave');
for (let i = 0; i < 10; i++) {
  const b = document.createElement('div');
  b.className = 'wbar'; b.style.height = '2px';
  waveEl.appendChild(b);
}
const waveBars = waveEl.querySelectorAll('.wbar');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.tab').forEach(t => {
  t.onclick = () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('on'));
    document.querySelectorAll('.scr').forEach(x => x.classList.remove('on'));
    t.classList.add('on');
    document.getElementById('tab-' + t.dataset.tab).classList.add('on');
  };
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETUP HANDLERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('saveApiBtn').onclick = () => {
  const inp = document.getElementById('apiKeyInput');
  const v = inp.value.trim();
  if (v.startsWith('â€¢')) { showToast('âœ“ Key saved'); return; }
  if (v.length < 15) { inp.classList.add('err'); setTimeout(() => inp.classList.remove('err'), 1500); return; }
  apiKey = v; localStorage.setItem('sai_key', v);
  inp.value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'; showToast('âœ“ API key saved!');
  document.querySelector('[data-tab="interview"]').click();
};
document.getElementById('saveResBtn').onclick = () => {
  resumeText = document.getElementById('resumeInput').value.trim();
  localStorage.setItem('sai_resume', resumeText);
  document.getElementById('resSaved').style.display = 'block';
  setTimeout(() => document.getElementById('resSaved').style.display = 'none', 2000);
  showToast('âœ“ Resume saved!');
};
document.getElementById('settingsBtn').onclick = () => document.querySelector('[data-tab="setup"]').click();
document.getElementById('clearBtn').onclick = () => {
  history = []; answers = 0; totalLatency = 0;
  msgsEl.innerHTML = `<div class="welcome"><span class="wico">ğŸ¥·</span><h3>Cleared!</h3><p>Ready for next question.</p></div>`;
  scnt.textContent = '0 answers';
};
roleInput.addEventListener('change', () => localStorage.setItem('sai_role', roleInput.value));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUESTION PATTERN DETECTION (no diarization needed)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function looksLikeQuestion(text) {
  if (!text || text.length < 4) return false;
  return QUESTION_PATTERNS.some(p => p.test(text.trim()));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 1: FAST CLASSIFIER â€” is this an interview question?
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function classifyQuestion(text) {
  // First: local pattern check (zero latency)
  if (looksLikeQuestion(text)) return true;

  // Second: if ambiguous, ask Gemini Flash (fast, cheap)
  try {
    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            role: 'user',
            parts: [{ text: `Is this an interview question or statement from an interviewer? Reply only YES or NO.\n\nText: "${text}"` }]
          }],
          generationConfig: { temperature: 0, maxOutputTokens: 5 }
        })
      }
    );
    const d = await res.json();
    if (d.error) return true; // if classifier fails, assume yes
    const ans = d.candidates[0].content.parts[0].text.trim().toUpperCase();
    return ans.startsWith('Y');
  } catch(e) {
    return true; // fail open
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARAKEET SYSTEM PROMPT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildSystemPrompt() {
  const role   = roleInput.value.trim();
  const resume = resumeText;
  let p = `You are a real-time interview assistant. The candidate is in a live job interview RIGHT NOW.

STRICT RULES:
1. Answer in 3-5 sentences MAX. Never longer unless code is required.
2. Use candidate resume/skills â€” make answers personal to their experience.
3. STAR format for behavioral: Situation (1 sentence), Task (1 sentence), Action (1-2 sentences), Result (1 sentence).
4. Technical: simple explanation + one real example from candidate's background.
5. HR/Culture: confident, growth mindset, team-oriented language.
6. Coding: pseudocode or short working snippet ONLY â€” no explanation unless asked.
7. Speak AS the candidate â€” first person ("I have", "I built", "In my experience").
8. Do NOT say you are an AI. Do NOT add disclaimers. No preamble.
9. Detect question type â€” output ONLY one of these on first line: [TECHNICAL] [BEHAVIORAL] [HR] [CODING] [GENERAL]
10. Second line: CONF:## (confidence score 0-100)
11. Third line onwards: the answer ONLY.

QUESTION TYPE RULES:
- TECHNICAL: DevOps, cloud, infra, architecture, tools, systems questions
- BEHAVIORAL: situation/challenge/conflict/team/leadership questions  
- HR: salary, culture, strengths, weaknesses, career, motivation questions
- CODING: write code, algorithm, debug, SQL, script questions
- GENERAL: anything else

TONE: Confident. Professional. Natural spoken language. Not robotic.`;

  if (role) p += `\n\nCANDIDATE APPLYING FOR: ${role}`;
  if (resume) p += `\n\nCANDIDATE BACKGROUND (use this to personalize answers):\n${resume}`;
  return p;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 2: FULL ANSWER GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function callGemini(question) {
  const sys = buildSystemPrompt();
  const contents = [
    { role: 'user',  parts: [{ text: sys }] },
    { role: 'model', parts: [{ text: 'Ready. I will give concise, first-person, Parakeet-style answers.' }] },
    ...history.map(m => ({
      role: m.role === 'assistant' ? 'model' : 'user',
      parts: [{ text: m.content }]
    })),
    { role: 'user', parts: [{ text: question }] }
  ];

  const res = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents,
        generationConfig: { temperature: 0.55, maxOutputTokens: 550 }
      })
    }
  );
  const d = await res.json();
  if (d.error) throw new Error(d.error.message);
  return d.candidates[0].content.parts[0].text;
}

async function callGeminiAudio(b64, mime) {
  const res = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          role: 'user',
          parts: [
            { inline_data: { mime_type: mime, data: b64 } },
            { text: 'Transcribe exactly what is said. Return ONLY the spoken words verbatim. If silence or inaudible, return empty string.' }
          ]
        }],
        generationConfig: { temperature: 0, maxOutputTokens: 200 }
      })
    }
  );
  const d = await res.json();
  if (d.error) throw new Error(d.error.message);
  return d.candidates[0].content.parts[0].text || '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTINUOUS VAD LISTENING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
micBtn.onclick = () => { isListening ? stopListen() : startListen(); };

async function startListen() {
  if (!apiKey) { showToast('âš  Add API key in Setup tab'); return; }
  try {
    ast.textContent = 'requesting mic...';
    micStream = await navigator.mediaDevices.getUserMedia({
      audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false, channelCount: 1 }
    });
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 512;
    analyser.smoothingTimeConstant = 0.5;
    audioCtx.createMediaStreamSource(micStream).connect(analyser);

    isListening = true;
    micBtn.classList.add('rec');
    rdot.classList.add('beat');
    micLbl.textContent = 'â¹ Stop';
    vadMini.style.display = 'flex';
    vadBadge.classList.add('on');
    ast.className = 'ast live';
    ast.textContent = 'ğŸ”´ listening...';
    stxt.textContent = 'listening';

    startBgRecorder();
    runVAD();
  } catch(e) {
    ast.textContent = 'âš  ' + e.message; ast.className = 'ast';
  }
}

function stopListen() {
  isListening = false;
  activeRec?.state === 'recording' && activeRec.stop();
  micStream?.getTracks().forEach(t => t.stop()); micStream = null;
  audioCtx?.close(); audioCtx = null; analyser = null;
  isSpeaking = false; silenceStart = null; speechStart = null;
  micBtn.classList.remove('rec'); rdot.classList.remove('beat');
  micLbl.textContent = 'ğŸ¤ Listen';
  vadMini.style.display = 'none';
  vadBadge.classList.remove('on');
  ast.className = 'ast'; ast.textContent = 'tap to start';
  stxt.textContent = 'ready';
}

function startBgRecorder() {
  if (!micStream) return;
  rollingChunks = [];
  try {
    activeRec = new MediaRecorder(micStream, { mimeType: 'audio/webm;codecs=opus' });
    rollingMime = 'audio/webm';
  } catch(e) {
    try { activeRec = new MediaRecorder(micStream, { mimeType: 'audio/webm' }); rollingMime = 'audio/webm'; }
    catch(e2) { activeRec = new MediaRecorder(micStream); rollingMime = 'audio/ogg'; }
  }
  activeRec.ondataavailable = e => {
    if (e.data?.size > 0) { rollingChunks.push(e.data); if (rollingChunks.length > 30) rollingChunks.shift(); }
  };
  activeRec.start(300); // 300ms slices for fine granularity
}

// VAD via Web Audio
const VAD_THRESH = 0.012;
const freqBuf = new Uint8Array(512);

function runVAD() {
  if (!isListening || !analyser) return;
  analyser.getByteFrequencyData(freqBuf);
  let sum = 0;
  for (let i = 0; i < freqBuf.length; i++) sum += (freqBuf[i] / 255) ** 2;
  const rms = Math.sqrt(sum / freqBuf.length);

  // Animate waveform
  waveBars.forEach((b, i) => {
    const h = isSpeaking ? 2 + Math.random() * rms * 100 : 2 + Math.sin(Date.now() / 300 + i) * 1.5;
    b.style.height = Math.min(14, h) + 'px';
  });
  // VAD level bar
  const pct = Math.min(100, rms * 500);
  vfill.style.width = pct + '%';
  vfill.style.background = rms > VAD_THRESH ? '#ff7777' : 'var(--ok)';

  const now = Date.now();
  if (rms > VAD_THRESH) {
    // SPEECH
    if (!isSpeaking) { isSpeaking = true; speechStart = now; silenceStart = null; ast.textContent = 'ğŸ”´ hearing...'; }
  } else {
    // SILENCE
    if (isSpeaking) {
      if (!silenceStart) silenceStart = now;
      if (now - silenceStart >= vadMs) {
        const spokenDuration = silenceStart - (speechStart || silenceStart);
        isSpeaking = false; silenceStart = null; speechStart = null;
        ast.className = 'ast proc';

        // Only process if speech was long enough (filters "uh", coughs etc.)
        if (spokenDuration >= minSpeechMs) {
          const snap = [...rollingChunks]; rollingChunks = [];
          processingQ = processingQ.then(() => processAudio(snap, rollingMime)).catch(console.error);
        } else {
          ast.className = 'ast live'; ast.textContent = 'ğŸ”´ listening...';
        }
      }
    }
  }
  requestAnimationFrame(runVAD);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROCESS AUDIO â€” non-blocking
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function processAudio(chunks, mime) {
  if (!isListening || !chunks.length) {
    if (isListening) { ast.className = 'ast live'; ast.textContent = 'ğŸ”´ listening...'; }
    return;
  }
  const blob = new Blob(chunks, { type: mime });
  if (blob.size < 2500) {
    if (isListening) { ast.className = 'ast live'; ast.textContent = 'ğŸ”´ listening...'; }
    return;
  }

  const t0 = Date.now();
  try {
    // Transcribe
    ast.textContent = 'âš¡ transcribing... (mic still open)';
    const b64 = await toB64(blob);
    const transcript = await callGeminiAudio(b64, mime.split(';')[0]);
    const q = transcript.trim();

    const tTranscribe = Date.now() - t0;

    if (!q || q.length < 4) {
      if (isListening) { ast.className = 'ast live'; ast.textContent = 'ğŸ”´ listening...'; }
      return;
    }

    // STEP 1: Classify (pattern first, then LLM if needed)
    ast.textContent = 'ğŸ” classifying...';
    const isQuestion = await classifyQuestion(q);
    const tClassify = Date.now() - t0 - tTranscribe;

    if (!isQuestion) {
      // Show skipped notification â€” brief
      appendSkipped(q);
      if (isListening) { ast.className = 'ast live'; ast.textContent = 'ğŸ”´ listening...'; }
      return;
    }

    // STEP 2: Full answer
    appendHeard(q);
    ast.textContent = 'âš¡ answering... (still listening)';
    await generateAnswer(q, t0);

  } catch(e) {
    appendErr(String(e).slice(0, 80));
  }

  if (isListening) { ast.className = 'ast live'; ast.textContent = 'ğŸ”´ listening...'; }
}

async function generateAnswer(question, t0 = Date.now()) {
  const tid = addTyping(); stxt.textContent = 'answering...';
  try {
    const raw = await callGemini(question);
    removeTyping(tid);
    const latencyMs = Date.now() - t0;
    totalLatency += latencyMs;
    const { type, conf, text } = parseResp(raw);
    history.push({ role: 'user', content: question });
    history.push({ role: 'assistant', content: text });
    if (history.length > 20) history = history.slice(-20);
    appendAI(text, type, conf, latencyMs);
    answers++;
    scnt.textContent = `${answers} answers Â· avg ${Math.round(totalLatency / answers)}ms`;
    stxt.textContent = isListening ? 'listening' : 'ready';
  } catch(e) {
    removeTyping(tid); appendErr(String(e)); stxt.textContent = 'âš  error';
  }
}

// Manual send
sendBtn.onclick = async () => {
  const q = chatInput.value.trim();
  if (!q || !apiKey) return;
  chatInput.value = ''; autoResize();
  clearWelcome(); appendUser(q);
  await generateAnswer(q);
};
chatInput.addEventListener('input', autoResize);
chatInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendBtn.click(); }
});
document.querySelectorAll('.chip').forEach(c => {
  c.onclick = () => { chatInput.value = c.dataset.p; chatInput.focus(); autoResize(); };
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARSE RESPONSE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseResp(raw) {
  let type = 'GENERAL', conf = 85, text = raw.trim();
  const tm = text.match(/^\[(TECHNICAL|BEHAVIORAL|HR|CODING|GENERAL)\]/i);
  if (tm) { type = tm[1].toUpperCase(); text = text.replace(tm[0], '').trim(); }
  const cm = text.match(/^CONF:(\d+)/im);
  if (cm) { conf = parseInt(cm[1]); text = text.replace(cm[0], '').trim(); }
  return { type, conf, text: text.trim() };
}

const TYPE_STYLES = {
  TECHNICAL: ['qt-tech', 'âš™ Technical'],
  BEHAVIORAL: ['qt-beh', 'â­ STAR'],
  HR: ['qt-hr', 'ğŸ¤ HR'],
  CODING: ['qt-cod', 'ğŸ’» Code'],
  GENERAL: ['qt-gen', 'ğŸ’¬ General']
};
function confColor(c) { return c >= 80 ? '#4ecca3' : c >= 60 ? '#ffaa44' : '#ff6b6b'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clearWelcome() { msgsEl.querySelector('.welcome')?.remove(); }

function appendUser(text) {
  clearWelcome();
  const d = mk('div', 'msg user');
  d.innerHTML = `<div class="mlbl">you</div><div class="mbub">${esc(text)}</div>`;
  msgsEl.appendChild(d); scrollDown();
}
function appendHeard(text) {
  clearWelcome();
  const d = mk('div', 'msg heard');
  d.innerHTML = `<div class="mlbl">ğŸ¤ heard</div><div class="mbub">${esc(text)}</div>`;
  msgsEl.appendChild(d); scrollDown();
}
function appendAI(text, type, conf, latency) {
  const d = mk('div', 'msg ai');
  const c = Math.min(100, Math.max(0, conf));
  const col = confColor(c);
  const [cls, lbl] = TYPE_STYLES[type] || TYPE_STYLES.GENERAL;
  const latStr = latency ? `<div class="latency">âš¡ ${latency}ms</div>` : '';
  d.innerHTML = `<div class="mlbl">ğŸ¤– answer</div>
    <div class="mbub">
      <span class="qtag ${cls}">${lbl}</span>
      ${fmt(text)}
      <div class="cbar">
        <span class="clbl">Confidence</span>
        <div class="ctrack"><div class="cfill" style="width:${c}%;background:${col}"></div></div>
        <span class="cpct" style="color:${col}">${c}%</span>
      </div>
      ${latStr}
    </div>`;
  msgsEl.appendChild(d); scrollDown();
}
function appendSkipped(text) {
  const d = mk('div', 'msg skipped');
  d.innerHTML = `<div class="mbub">â­ skipped (not a question): "${esc(text.slice(0,50))}${text.length>50?'â€¦':''}"</div>`;
  msgsEl.appendChild(d); scrollDown();
}
function appendErr(msg) {
  const d = mk('div', 'errbub'); d.textContent = 'âš  ' + msg;
  msgsEl.appendChild(d); scrollDown();
}
function addTyping() {
  const id = 'ty' + Date.now();
  const d = mk('div', 'twrap'); d.id = id;
  d.innerHTML = '<div class="tdots"><span></span><span></span><span></span></div><span class="ttxt">generating answer...</span>';
  msgsEl.appendChild(d); scrollDown(); return id;
}
function removeTyping(id) { document.getElementById(id)?.remove(); }

function fmt(t) {
  t = t.replace(/```(\w*)\n?([\s\S]*?)```/g, (_,l,c) => `<pre><code>${esc(c.trim())}</code></pre>`);
  t = t.replace(/`([^`]+)`/g, (_,c) => `<code>${esc(c)}</code>`);
  t = t.replace(/\*\*([^*\n]+)\*\*/g, '<strong>$1</strong>');
  t = t.replace(/\*([^*\n]+)\*/g, '<em>$1</em>');
  t = t.replace(/^#{1,3}\s+(.+)$/gm, '<strong>$1</strong>');
  return t;
}
function esc(t) { return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function mk(tag, cls) { const e = document.createElement(tag); e.className = cls; return e; }
function scrollDown() { setTimeout(() => msgsEl.scrollTop = msgsEl.scrollHeight, 30); }
function autoResize() { chatInput.style.height='36px'; chatInput.style.height=Math.min(chatInput.scrollHeight,90)+'px'; }

function toB64(blob) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onloadend = () => res(r.result.split(',')[1]);
    r.onerror = rej; r.readAsDataURL(blob);
  });
}
function showToast(msg) {
  const t = document.createElement('div');
  t.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#1a1a2e;border:1px solid #7c6cfc50;color:#e8e8f0;padding:9px 18px;border-radius:50px;font-size:12px;font-weight:600;z-index:9999;pointer-events:none';
  t.textContent = msg; document.body.appendChild(t);
  setTimeout(() => t.remove(), 2000);
}
if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});
</script>
</body>
</html>
